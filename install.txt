== 內容 ==
本專案為318公民運動數位典藏系統之源碼，程式碼為專為318公民運動數位典藏系統撰寫，但經由適當修正後，應可應用於其他相似典藏系統。
本專案包含三個部份：
1)典藏系統
2)公眾系統
3)特展系統
其中1) 2)項基於drupal 7開發；3)則採用nodejs。
1) 2) 項彼此相依，3) 則為可獨立之系統。

== 準備 ==
*) 本專案需安裝於三個網址，以下安裝流程，均以下述三網址為例
  1)典藏系統 archive.318.test
  2)公眾系統 public.318.test
  3)特展系統 expo.318.test
*) 本安裝流程，均以/data為根目錄，安裝前，請先將drupal和expo置於/data下。

== 典藏與公眾系統 ==
典藏與公眾系統共用檔案系統與資料庫，預設為安裝於同一伺服器。分開安裝會導致系統無法運作。

=== 安裝 ===
1. 安裝LAMP
   本系統預設安裝之作業系統環境為 Linux，並於 Apache2, PHP5(>=5.2.5), MySql 5(>=5.0.15)上運行。本系統開發環境為ubuntu 14.04, Apache 2.4.7, PHP 5.5.9, mysql 5.5.46。請參考drupal安手冊安裝必要元件。
   # apt-get install apache2 mysql-server php5 php5-mysql php5-gd

2. 安裝LAMP額外模組與設定
* Apache2
  *) 啟用 "rewrite" 模組。
   # a2enmod rewrite
  *)  設定Apache虛擬主機設定檔，請參考conf/apache-318.conf
* Mysql，建立三個資料庫（database）
   *) db_archive
   *) db_public
   *) db_claim

* PHP
  *) 修改php.ini如下
   post_max_size = 40M
   upload_max_filesize = 40M

3. 安裝全文搜尋引擎 SphinxSearch
  *) 將conf/sphinx.conf置於/etc/sphinxsearch
  *) 修改sphinx.conf中資料庫帳號密碼
  *) 設定indexer的suid權限
     chmod u+s /usr/bin/indexer

4. 安裝 drush
   # apt-get install drush
5. 安裝 Unzip
   # apt-get install unzip
6. 安裝 avconv
   # apt-get install libav-tools
7. 安裝 ImageMagick
   # apt-get install imagemagick
8. 安裝所需字型，如 fonts-arphic-ukai
   # apt-get install fonts-arphic-ukai
   # apt-get install xfonts-75dpi
9. 安裝 wkhtmltopdf

   For 64 bit Ubuntu
   # wget http://download.gna.org/wkhtmltopdf/0.12/0.12.2.1/wkhtmltox-0.12.2.1_linux-trusty-amd64.deb
   # dpkg -i wkhtmltox-0.12.2.1_linux-trusty-amd64.deb

   For 32 bit Ubuntu
   # wget http://download.gna.org/wkhtmltopdf/0.12/0.12.2.1/wkhtmltox-0.12.2.1_linux-trusty-i386.deb
   # dpkg -i wkhtmltox-0.12.2.1_linux-trusty-i386.deb

=== 設定 ===
1. 匯入預設資料庫，預設資料庫位於db/下，三個資料庫都必須安裝
2. 修改drupal設定檔，填入正確的資料庫帳號密碼
   *) /data/drupal/sites/archive/settings.php
   *) /data/drupal/sites/public/settings.php
   *) 如果你安裝在不同網址，也需修改 /data/drupal/sites/sites
3. 確認Apache擁有讀寫files目錄的權限
  # chmod -R a+rw /data/drupal/sites/archive/files
  # chmod -R a+rw /data/drupal/sites/public/files

4. 使用前建議先清除快取。

   # cd /data/drupal/sites/archive; drush cc;
   # cd /data/drupal/sites/public; drush cc;

5. 如果你將系統安裝在不同網址或目錄，請至http://[archive system url]/admin/config/coll/settings修改設定，修改前你必須要先登入系統

6. 登入系統請至http://[「archive or public system url]/user/loginl，預設的管理者帳號密碼為 root : 12345qaz，在典藏系統中，另有一較安全的管理帳號為 318admin : 123456

7. 你可以加上適當的權限控管，如apach httpasswd以保護典藏系統不對外公開。

8. 若你的主機無法安裝寄件伺服器，你可以使用 gmail 來寄信。請到 admin/config/system/smtp 設定。

   在 SMTP server settings 的部份，使用下面的值

   SMTP Server: smtp.gmail.com
   SMTP port  : 587
   Use encrypted protocol: Use TLS

   在 SMTP Authentication 的部份，請填入你的 Gmail 帳號，需注意的是使用 Gmail 來寄信，需要降低安全層級，請登入 Gmail 後到下面網址設定。

   https://www.google.com/settings/security/lesssecureapps?pli=1

== 特展系統 ==

=== 安裝 ===
1. 安裝與啟用apache模組，特展系統需要啟用 "proxy proxy_ajp proxy_http deflate headers proxy_balancer proxy_connect proxy_html xml2enc" 模組。
   # apt-get install libapache2-mod-proxy-html
   # a2enmod
     Enable the following modules in the interactive cli of a2enmod. "proxy proxy_ajp proxy_http rewrite deflate headers proxy_balancer proxy_connect proxy_html xml2enc"

2. 設定Apache虛擬主機設定檔，請參考conf/apache-318-expo.conf

3. 安裝 Nodejs 與套件
   # apt-get install nodejs
   # apt-get install npm
   # apt-get install mongodb
   # apt-get install libcairo2-dev libjpeg8-dev libpango1.0-dev libgif-dev build-essential g++
   # npm -g install forever


=== 設定 ===
1. 在 /etc/rc.local 中加入
      NODE_ENV=production /usr/local/bin/forever start -a -l forever.log -o /data/expo/out.log -e /data/expo/err.log /data/expo/bin/www-mongo
2. 創建
      # cd /data/expo
      # make restore
      # make forever
